IF OBJECT_ID('tempdb..#CLZLKC') IS NOT NULL DROP TABLE #CLZLKC
SELECT CLZL.CLDH,CLZL.CLLB,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,LastKC.LastRem,RK.RKQty,QC.QCQty
      ,LL.LLQty,JGRK.JGRK,JGCK.JGCK,CLZL1.CKBH, case when CHARINDEX('K',CLZL1.XXCC)>0 then ' '+ CLZL1.XXCC else CLZL1.XXCC end XXCC,CLZL1.HGLB,CLZL1.RKNO INTO #CLZLKC
FROM(
	    SELECT CLBH,CKBH,Ltrim(Rtrim(XXCC)) XXCC,HGLB,RKNO FROM #LastKC_N371 GROUP BY CLBH,CKBH,XXCC,HGLB,RKNO
     UNION
	    SELECT CLBH,CKBH,Ltrim(Rtrim(XXCC)) XXCC,HGLB,RKNO FROM #RK_N371 GROUP BY CLBH,CKBH,XXCC,HGLB,RKNO
     UNION
     SELECT CLBH,CKBH,Ltrim(Rtrim(XXCC)) XXCC,HGLB,RKNO FROM #JGRK_N371 GROUP BY CLBH,CKBH,HGLB,RKNO,XXCC
     UNION
     SELECT CLBH,CKBH,Ltrim(Rtrim(XXCC)) XXCC,HGLB,RKNO FROM #LL GROUP BY CLBH,CKBH,XXCC,HGLB,RKNO
     UNION
     SELECT ZMLB,CKBH,Ltrim(Rtrim(XXCC)) XXCC,HGLB,RKNO FROM #JGCK_N371 GROUP BY ZMLB,CKBH,HGLB,RKNO,XXCC
     )CLZL1
LEFT JOIN #LastKC_N371 LastKC ON LastKC.CLBH=CLZL1.CLBH AND LastKC.CKBH=CLZL1.CKBH AND LastKC.XXCC=CLZL1.XXCC AND LastKC.HGLB=CLZL1.HGLB AND LastKC.RKNO=CLZL1.RKNO
LEFT JOIN (SELECT CLBH,CKBH,XXCC,HGLB,RKNO,SUM(RKQty) RKQty
           FROM #RK_N371 GROUP BY CLBH,CKBH,XXCC,HGLB,RKNO)RK ON RK.CLBH=CLZL1.CLBH AND RK.CKBH=CLZL1.CKBH AND Ltrim(Rtrim(RK.XXCC))=Ltrim(Rtrim(CLZL1.XXCC)) AND RK.HGLB=CLZL1.HGLB AND RK.RKNO=CLZL1.RKNO
LEFT JOIN (SELECT CLBH,CKBH,XXCC,HGLB,RKNO,SUM(RKQty) QCQty FROM #RK_N371
           WHERE QCID='NO' GROUP BY CLBH,CKBH,XXCC,HGLB,RKNO)QC ON QC.CLBH=CLZL1.CLBH AND QC.CKBH=CLZL1.CKBH AND Ltrim(Rtrim(QC.XXCC))=Ltrim(Rtrim(CLZL1.XXCC)) AND QC.HGLB=CLZL1.HGLB AND QC.RKNO=CLZL1.RKNO
LEFT JOIN #LL LL ON LL.CLBH=CLZL1.CLBH AND LL.CKBH=CLZL1.CKBH AND Ltrim(Rtrim(LL.XXCC))=Ltrim(Rtrim(CLZL1.XXCC)) AND LL.HGLB=CLZL1.HGLB AND LL.RKNO=CLZL1.RKNO
LEFT JOIN #JGRK_N371 JGRK ON JGRK.CLBH=CLZL1.CLBH AND JGRK.CKBH=CLZL1.CKBH AND JGRK.HGLB=CLZL1.HGLB AND JGRK.RKNO=CLZL1.RKNO AND Ltrim(Rtrim(CLZL1.XXCC))=Ltrim(Rtrim(JGRK.XXCC)) 
LEFT JOIN #JGCK_N371 JGCK ON JGCK.ZMLB=CLZL1.CLBH AND JGCK.CKBH=CLZL1.CKBH AND JGCK.HGLB=CLZL1.HGLB AND JGCK.RKNO=CLZL1.RKNO AND Ltrim(Rtrim(CLZL1.XXCC))=Ltrim(Rtrim(JGCK.XXCC)) 
LEFT JOIN #CLZL_N371 CLZL ON CLZL.CLDH=CLZL1.CLBH
WHERE NOT (LastKC.LastRem IS NULL AND RK.RKQty IS NULL AND LL.LLQty IS NULL AND JGRK.JGRK IS NULL AND JGCK.JGCK IS NULL)
CREATE CLUSTERED INDEX cx_CLZLKC ON #CLZLKC (CLDH,CKBH,XXCC,HGLB,RKNO)
